Syncthing deployment
=============================

Initialization
------------------------------

Generate the Syncthing instance configuration file and identity certificates by running the Docker container locally (create a folder `config` to capture the files):

```
$ docker run -it --rm --name syncthing \
    -v "$(pwd)/config":/srv/config \
    -u syncthing \
    lsstdm/transfer-ingest-monitor-syncthing:latest \
    bash

syncthing@bd919f7d54a1:/srv$ /srv/syncthing/syncthing -home=/srv/config
```

This will generate the `config.xml` and `cert.pem` and `key.pem` files you will need to upload to the persistent storage of the deployed Syncthing app.

The Syncthing config is stored as a Kubernetes Secret. In the case of the public-facing deployment on the LSST Sandbox, the secret is stored in the Vault and automatically generated by the VSO. For the TIM deployment on the NCSA Integration cluster, the secret must be manually generate and applied like so:

```
python3 ./scripts/secret_generator/generate_secret.py \
    --name transfer-ingest-monitor-syncthing-config \
    --output transfer-ingest-monitor-syncthing-config.secret.yaml \
    src/syncthing/instance-config/transfer-ingest-monitor-source/config/{config.xml,cert.pem,key.pem}

kubectl apply --namespace=lsst-dm -f transfer-ingest-monitor-syncthing-config.secret.yaml 
```

**WARNING**: If either of the Syncthing configs are lost (`config.xml` and/or key pair) and must be regenerated, then the other Syncthing `config.xml` file must be updated with the new Device ID.

Data synchronization
------------------------------

To synchronize data between the Syncthing instances, their configurations must be modified to provide each with the Device ID of the other and with the shared folder information.

Read about the config spec at https://docs.syncthing.net/users/config.html#config-file-format.

For example, adding the following to the Syncthing instance `config.xml` on the public-facing deployment configures Syncthing to connect to the other instance (named `transfer-ingest-monitor-source`) and sync the `webfiles` folder share in `receiveonly` mode.

```
    ...
    <device id="VJ6RLU3-...-JKYVPQ7" name="transfer-ingest-monitor-source" compression="metadata" introducer="false" skipIntroductionRemovals="false" introducedBy="">
        <address>dynamic</address>
        <paused>false</paused>
        <autoAcceptFolders>true</autoAcceptFolders>
        <maxSendKbps>0</maxSendKbps>
        <maxRecvKbps>0</maxRecvKbps>
        <maxRequestKiB>0</maxRequestKiB>
        <untrusted>false</untrusted>
        <remoteGUIPort>0</remoteGUIPort>
    </device>
    <folder id="webfiles" label="webfiles" path="/srv/data" type="receiveonly" rescanIntervalS="3600" fsWatcherEnabled="true" fsWatcherDelayS="10" ignorePerms="false" autoNormalize="true">
        <filesystemType>basic</filesystemType>
        <device id="VJ6RLU3-...-JKYVPQ7" introducedBy="">
            <encryptionPassword></encryptionPassword>
        </device>
        <device id="WUURFXM-...-E56JMQB" introducedBy="">
            <encryptionPassword></encryptionPassword>
        </device>
    </folder>
    ...
```

Conversely, on the Integration cluster Syncthing deployment, the same folder is shared in `sendonly` mode.